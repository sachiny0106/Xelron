name: Ruff

on:
  pull_request:
    branches: ["main"]

jobs:
  lint-and-format:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history to get the base branch
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.head_ref }} # Checkout the PR branch
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"

      - name: Set up Python 3.13
        run: uv python pin 3.13

      - name: Run ruff linting on entire codebase
        run: uvx ruff check --fix .

      - name: Get changed Python files
        id: changed-files
        run: |
          # Add the base repository as upstream remote and fetch the base branch
          git remote add upstream https://github.com/${{ github.repository }}.git
          git fetch upstream ${{ github.base_ref }}

          # Get list of changed Python files
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACMRT upstream/${{ github.base_ref }}...HEAD | grep '\.py$' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No Python files changed"
            echo "files=" >> $GITHUB_OUTPUT
            echo "has_files=false" >> $GITHUB_OUTPUT
          else
            echo "Changed Python files:"
            echo "$CHANGED_FILES"
            # Convert newlines to spaces for the command
            FILES_LIST=$(echo "$CHANGED_FILES" | tr '\n' ' ')
            echo "files=$FILES_LIST" >> $GITHUB_OUTPUT
            echo "has_files=true" >> $GITHUB_OUTPUT
          fi

      - name: Run ruff format on changed files and check
        if: steps.changed-files.outputs.has_files == 'true'
        run: |
          # Run ruff format on the changed files
          uvx ruff format ${{ steps.changed-files.outputs.files }}

          # Check if there are any changes after formatting
          FORMATTED_CHANGES=$(git status --porcelain ${{ steps.changed-files.outputs.files }} || true)
          if [[ -n "$FORMATTED_CHANGES" ]]; then
            echo "::error::Code formatting is required. Please run the following command locally and push the changes:"
            echo "::error::uvx ruff format ${{ steps.changed-files.outputs.files }}"
            echo ""
            echo "Files that need formatting:"
            echo "$FORMATTED_CHANGES"
            exit 1
          else
            echo "No formatting changes needed"
          fi
